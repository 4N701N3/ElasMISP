{% extends "base.html" %}

{% block title %}IOCs - {{ SITE_TITLE }}{% endblock %}

{% block content %}
<div class="top-bar">
    <h4 class="mb-0">IOC List</h4>
    <div class="d-flex align-items-center gap-3">
        <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" class="form-control" id="quickSearch" placeholder="Quick search...">
        </div>
        <a href="{{ url_for('main.iocs_graph') }}" class="btn btn-outline-info">
            <i class="bi bi-diagram-3 me-1"></i> Graph View
        </a>
        <a href="{{ url_for('main.iocs_add') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Add IOC
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-2">
                <select class="form-select" id="filterType">
                    <option value="">All Types</option>
                    <option value="md5">MD5</option>
                    <option value="sha1">SHA1</option>
                    <option value="sha256">SHA256</option>
                    <option value="ipv4">IPv4</option>
                    <option value="domain">Domain</option>
                    <option value="email">Email</option>
                    <option value="url">URL</option>
                    <option value="asn">ASN</option>
                    <option value="file-path">File Path</option>
                    <option value="process-name">Process Name</option>
                    <option value="registry-key">Registry Key</option>
                    <option value="windows-registry-key">Windows Registry</option>
                    <option value="mutex">Mutex</option>
                    <option value="certificate-serial">Cert Serial</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="filterTLP">
                    <option value="">All TLP</option>
                    <option value="white">White</option>
                    <option value="green">Green</option>
                    <option value="amber">Amber</option>
                    <option value="red">Red</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="filterThreatLevel">
                    <option value="">All Threat Levels</option>
                    <option value="unknown">Unknown</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="filterConfidence">
                    <option value="">All Confidence</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="very-high">Very High</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" id="filterCampaigns" placeholder="Filter by campaigns...">
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-primary w-100" id="applyFilters">
                    <i class="bi bi-funnel me-1"></i> Apply
                </button>
            </div>
        </div>
        <div class="row g-3 mt-2">
            <div class="col-md-12">
                <input type="text" class="form-control" id="filterLabels" placeholder="Filter by labels (comma-separated)...">
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Toolbar -->
<div class="card mb-3 d-none" id="bulkActionsBar">
    <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="me-3"><strong id="selectedCount">0</strong> items selected</span>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="selectAllVisible()">
                    <i class="bi bi-check-all me-1"></i> Select All
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                    <i class="bi bi-x-lg me-1"></i> Clear
                </button>
            </div>
            <div>
                <div class="btn-group me-2">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-tag me-1"></i> Set TLP
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('tlp', 'white')">White</a></li>
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('tlp', 'green')">Green</a></li>
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('tlp', 'amber')">Amber</a></li>
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('tlp', 'red')">Red</a></li>
                    </ul>
                </div>
                <div class="btn-group me-2">
                    <button class="btn btn-sm btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-exclamation-triangle me-1"></i> Set Threat
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('threat_level', 'low')">Low</a></li>
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('threat_level', 'medium')">Medium</a></li>
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('threat_level', 'high')">High</a></li>
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('threat_level', 'critical')">Critical</a></li>
                    </ul>
                </div>
                <div class="btn-group me-2">
                    <button class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-shield me-1"></i> Set Status
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('status', 'active')">Active</a></li>
                        <li><a class="dropdown-item" href="#" onclick="bulkSetField('status', 'archived')">Archived</a></li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-outline-success me-2" onclick="bulkExport()">
                    <i class="bi bi-download me-1"></i> Export
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash me-1"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- IOC Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="iocTable">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                        <th onclick="sortTable('type')" style="cursor: pointer;" class="sortable-header">
                            Type <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th onclick="sortTable('value')" style="cursor: pointer;" class="sortable-header">
                            Pattern / Value <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th onclick="sortTable('risk_score')" style="cursor: pointer;" class="sortable-header">
                            Risk <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th>Labels</th>
                        <th onclick="sortTable('tlp')" style="cursor: pointer;" class="sortable-header">
                            TLP <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th onclick="sortTable('threat_level')" style="cursor: pointer;" class="sortable-header">
                            Threat <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th onclick="sortTable('confidence')" style="cursor: pointer;" class="sortable-header">
                            Confidence <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th onclick="sortTable('sources_count')" style="cursor: pointer;" class="sortable-header">
                            Sources <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th onclick="sortTable('relations_count')" style="cursor: pointer;" class="sortable-header">
                            Links <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th onclick="sortTable('created')" style="cursor: pointer;" class="sortable-header">
                            Created <i class="bi bi-arrow-down-up" style="font-size: 0.8rem; opacity: 0.5;"></i>
                        </th>
                        <th width="100">Actions</th>
                    </tr>
                </thead>
                <tbody id="iocTableBody">
                    <tr>
                        <td colspan="12" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> IOCs
            </div>
            <nav>
                <ul class="pagination mb-0" id="pagination">
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
const perPage = 20;
let sortColumn = null;
let sortOrder = 'asc'; // 'asc' or 'desc'
let allIOCs = []; // Store all IOCs for client-side sorting

function loadIOCs(page = 1) {
    currentPage = page;
    const type = $('#filterType').val();
    const tlp = $('#filterTLP').val();
    const threatLevel = $('#filterThreatLevel').val();
    const confidence = $('#filterConfidence').val();
    const campaigns = $('#filterCampaigns').val();
    const labels = $('#filterLabels').val();
    
    let url = `/api/ioc?page=${page}&per_page=${perPage}`;
    if (type) url += `&type=${type}`;
    if (tlp) url += `&tlp=${tlp}`;
    if (threatLevel) url += `&threat_level=${threatLevel}`;
    if (confidence) url += `&confidence=${confidence}`;
    if (campaigns) url += `&campaigns=${encodeURIComponent(campaigns)}`;
    if (labels) url += `&labels=${encodeURIComponent(labels)}`;
    
    $.get(url, function(data) {
        allIOCs = data.items; // Store IOCs for sorting
        
        // Add computed properties for sorting
        allIOCs.forEach(ioc => {
            ioc.sources_count = (ioc.sources || []).length;
            ioc.relations_count = ioc.relations_count || 0;
        });
        
        // Apply sorting if active
        if (sortColumn) {
            applySorting();
        }
        
        renderIOCs(allIOCs);
        renderPagination(data.total, page);
        $('#showingCount').text(data.items.length);
        $('#totalCount').text(data.total);
    });
}

function sortTable(column) {
    // Toggle sort order if clicking the same column
    if (sortColumn === column) {
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortOrder = 'asc';
    }
    
    // Update visual indicators
    updateSortIndicators();
    
    // Apply sorting
    applySorting();
    
    // Re-render the table
    renderIOCs(allIOCs);
}

function updateSortIndicators() {
    // Reset all headers
    $('.sortable-header i').css({
        'opacity': '0.5',
        'transform': 'rotate(0deg)'
    });
    
    // Highlight active column
    if (sortColumn) {
        const headers = $('th');
        headers.each(function() {
            const text = $(this).text().trim();
            let headerColumn = null;
            
            // Map header text to column name
            if (text.includes('Type')) headerColumn = 'type';
            else if (text.includes('Pattern')) headerColumn = 'value';
            else if (text.includes('Risk')) headerColumn = 'risk_score';
            else if (text.includes('TLP')) headerColumn = 'tlp';
            else if (text.includes('Threat')) headerColumn = 'threat_level';
            else if (text.includes('Confidence')) headerColumn = 'confidence';
            else if (text.includes('Sources')) headerColumn = 'sources_count';
            else if (text.includes('Links')) headerColumn = 'relations_count';
            else if (text.includes('Created')) headerColumn = 'created';
            
            if (headerColumn === sortColumn) {
                const icon = $(this).find('i');
                icon.css('opacity', '1');
                if (sortOrder === 'desc') {
                    icon.css('transform', 'rotate(180deg)');
                }
            }
        });
    }
}

function applySorting() {
    if (!sortColumn || !allIOCs) return;
    
    allIOCs.sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];
        
        // Handle null/undefined values
        if (aVal === null || aVal === undefined) aVal = '';
        if (bVal === null || bVal === undefined) bVal = '';
        
        // Convert to lowercase for string comparison
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
        
        // Compare
        if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
        return 0;
    });
}

function renderIOCs(iocs) {
    const tbody = $('#iocTableBody');
    tbody.empty();
    
    if (iocs.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="12" class="text-center py-4 text-muted">
                    No IOCs found
                </td>
            </tr>
        `);
        return;
    }
    
    // Color mappings
    const tlpColors = {
        'white': 'secondary',
        'green': 'success',
        'amber': 'warning',
        'red': 'danger'
    };
    
    const threatColors = {
        'unknown': 'secondary',
        'low': 'info',
        'medium': 'warning',
        'high': 'danger',
        'critical': 'dark'
    };
    
    const confidenceColors = {
        'low': 'secondary',
        'medium': 'info',
        'high': 'success',
        'very-high': 'primary'
    };
    
    function getRiskScoreClass(score) {
        if (score >= 80) return 'danger';
        if (score >= 60) return 'warning';
        if (score >= 40) return 'info';
        if (score >= 20) return 'secondary';
        return 'light';
    }
    
    iocs.forEach(ioc => {
        const labels = (ioc.labels || []).slice(0, 3).map(l => 
            `<span class="badge bg-light text-dark">${l}</span>`
        ).join(' ');
        const moreLabels = ioc.labels && ioc.labels.length > 3 ? 
            `<span class="badge bg-secondary">+${ioc.labels.length - 3}</span>` : '';
        
        const tlpBadge = ioc.tlp ? 
            `<span class="badge bg-${tlpColors[ioc.tlp] || 'secondary'}">${ioc.tlp.toUpperCase()}</span>` : 
            '<span class="text-muted">-</span>';
        
        const threatBadge = ioc.threat_level ? 
            `<span class="badge bg-${threatColors[ioc.threat_level] || 'secondary'}">${ioc.threat_level}</span>` : 
            '<span class="text-muted">-</span>';
        
        const confidenceBadge = ioc.confidence ? 
            `<span class="badge bg-${confidenceColors[ioc.confidence] || 'secondary'}">${ioc.confidence}</span>` : 
            '<span class="text-muted">-</span>';
        
        const relationsCount = ioc.relations_count || 0;
        const relationsDisplay = relationsCount > 0 ? 
            `<span class="badge bg-warning text-dark">${relationsCount}</span>` : 
            '<span class="text-muted">-</span>';
        
        const riskScore = ioc.risk_score || 0;
        const riskScoreClass = getRiskScoreClass(riskScore);
        const riskScoreBadge = `<span class="badge bg-${riskScoreClass}" title="Risk Score">${riskScore}</span>`;
        
        const isSelected = selectedIOCs.has(ioc.id);
        
        tbody.append(`
            <tr data-ioc-id="${ioc.id}">
                <td><input type="checkbox" class="ioc-checkbox" value="${ioc.id}" ${isSelected ? 'checked' : ''} onchange="toggleIOCSelection('${ioc.id}')"></td>
                <td><span class="ioc-type-badge ioc-type-${ioc.ioc_type}">${(ioc.ioc_type || '').toUpperCase()}</span></td>
                <td>
                    <code class="pattern-text">${(ioc.pattern || '').substring(0, 60)}${ioc.pattern && ioc.pattern.length > 60 ? '...' : ''}</code>
                </td>
                <td>${riskScoreBadge}</td>
                <td>${labels} ${moreLabels}</td>
                <td>${tlpBadge}</td>
                <td>${threatBadge}</td>
                <td>${confidenceBadge}</td>
                <td><span class="badge bg-info">${(ioc.sources || []).length}</span></td>
                <td>${relationsDisplay}</td>
                <td><small class="text-muted">${ioc.created ? ioc.created.substring(0, 10) : ''}</small></td>
                <td>
                    <a href="/iocs/${ioc.id}" class="btn btn-sm btn-outline-primary" title="View">
                        <i class="bi bi-eye"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteIOC('${ioc.id}')" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
}

function renderPagination(total, current) {
    const totalPages = Math.ceil(total / perPage);
    const pagination = $('#pagination');
    pagination.empty();
    
    if (totalPages <= 1) return;
    
    // Previous
    pagination.append(`
        <li class="page-item ${current === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadIOCs(${current - 1}); return false;">Previous</a>
        </li>
    `);
    
    // Page numbers
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        pagination.append(`
            <li class="page-item ${i === current ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadIOCs(${i}); return false;">${i}</a>
            </li>
        `);
    }
    
    // Next
    pagination.append(`
        <li class="page-item ${current === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadIOCs(${current + 1}); return false;">Next</a>
        </li>
    `);
}

function deleteIOC(id) {
    if (!confirm('Are you sure you want to delete this IOC?')) return;
    
    $.ajax({
        url: `/api/ioc/${id}`,
        method: 'DELETE',
        success: function() {
            showAlert('IOC deleted successfully', 'success');
            loadIOCs(currentPage);
        },
        error: function(xhr) {
            showAlert('Failed to delete IOC', 'danger');
        }
    });
}

// Bulk Selection
const selectedIOCs = new Set();

function toggleIOCSelection(id) {
    if (selectedIOCs.has(id)) {
        selectedIOCs.delete(id);
    } else {
        selectedIOCs.add(id);
    }
    updateBulkActionsBar();
}

function toggleSelectAll() {
    const isChecked = $('#selectAllCheckbox').prop('checked');
    if (isChecked) {
        $('.ioc-checkbox').each(function() {
            selectedIOCs.add($(this).val());
            $(this).prop('checked', true);
        });
    } else {
        $('.ioc-checkbox').each(function() {
            selectedIOCs.delete($(this).val());
            $(this).prop('checked', false);
        });
    }
    updateBulkActionsBar();
}

function selectAllVisible() {
    $('.ioc-checkbox').each(function() {
        selectedIOCs.add($(this).val());
        $(this).prop('checked', true);
    });
    $('#selectAllCheckbox').prop('checked', true);
    updateBulkActionsBar();
}

function clearSelection() {
    selectedIOCs.clear();
    $('.ioc-checkbox').prop('checked', false);
    $('#selectAllCheckbox').prop('checked', false);
    updateBulkActionsBar();
}

function updateBulkActionsBar() {
    const count = selectedIOCs.size;
    $('#selectedCount').text(count);
    if (count > 0) {
        $('#bulkActionsBar').removeClass('d-none');
    } else {
        $('#bulkActionsBar').addClass('d-none');
    }
}

function bulkSetField(field, value) {
    if (selectedIOCs.size === 0) {
        showAlert('No IOCs selected', 'warning');
        return;
    }
    
    const updates = {};
    updates[field] = value;
    
    $.ajax({
        url: '/api/ioc/bulk/update',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            ioc_ids: Array.from(selectedIOCs),
            updates: updates
        }),
        success: function(data) {
            showAlert(`Updated ${data.updated} IOCs`, 'success');
            clearSelection();
            loadIOCs(currentPage);
        },
        error: function(xhr) {
            showAlert('Bulk update failed', 'danger');
        }
    });
}

function bulkDelete() {
    if (selectedIOCs.size === 0) {
        showAlert('No IOCs selected', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selectedIOCs.size} IOCs?`)) return;
    
    $.ajax({
        url: '/api/ioc/bulk/delete',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            ioc_ids: Array.from(selectedIOCs)
        }),
        success: function(data) {
            showAlert(`Deleted ${data.deleted} IOCs`, 'success');
            clearSelection();
            loadIOCs(currentPage);
        },
        error: function(xhr) {
            showAlert('Bulk delete failed', 'danger');
        }
    });
}

function bulkExport() {
    if (selectedIOCs.size === 0) {
        showAlert('No IOCs selected', 'warning');
        return;
    }
    
    $.ajax({
        url: '/api/ioc/bulk/export',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            ioc_ids: Array.from(selectedIOCs),
            format: 'json'
        }),
        success: function(data) {
            // Download as file
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'iocs_export.json';
            a.click();
            window.URL.revokeObjectURL(url);
        },
        error: function(xhr) {
            showAlert('Export failed', 'danger');
        }
    });
}

// Event handlers
$('#applyFilters').click(function() {
    loadIOCs(1);
});

$('#quickSearch').on('keyup', function(e) {
    if (e.key === 'Enter') {
        window.location.href = `/search?q=${encodeURIComponent($(this).val())}`;
    }
});

// Initial load
$(document).ready(function() {
    loadIOCs(1);
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}IOC Detail - {{ SITE_TITLE }}{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.29.2/cytoscape.min.css" rel="stylesheet">
<style>
.json-tree {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 8px;
    padding: 16px;
    border-left: 4px solid #007bff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.json-tree ul {
    list-style: none;
    padding-left: 0;
    margin: 4px 0;
}

.json-tree li {
    padding-left: 20px;
    margin: 6px 0;
    line-height: 1.6;
}

.json-tree .toggle {
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    margin-left: -20px;
    margin-right: 6px;
    text-align: center;
    color: #666;
    user-select: none;
    font-size: 0.8rem;
    font-weight: bold;
    transition: all 0.2s ease;
}

.json-tree .toggle:hover {
    color: #007bff;
    transform: scale(1.2);
}

.json-tree .key {
    color: #d73a49;
    font-weight: 600;
    margin-right: 4px;
}

.json-tree .key::before {
    content: '"';
}

.json-tree .key::after {
    content: '"';
}

.json-tree .string {
    color: #032f62;
    background: rgba(3, 47, 98, 0.05);
    padding: 2px 4px;
    border-radius: 3px;
}

.json-tree .string::before {
    content: '"';
}

.json-tree .string::after {
    content: '"';
}

.json-tree .number {
    color: #005cc5;
    font-weight: 600;
    background: rgba(0, 92, 197, 0.05);
    padding: 2px 4px;
    border-radius: 3px;
}

.json-tree .boolean {
    color: #d73a49;
    font-weight: bold;
    background: rgba(215, 58, 73, 0.05);
    padding: 2px 4px;
    border-radius: 3px;
}

.json-tree .null {
    color: #6f42c1;
    font-style: italic;
    background: rgba(111, 66, 193, 0.05);
    padding: 2px 4px;
    border-radius: 3px;
}

.json-tree .bracket {
    color: #333;
    font-weight: 600;
}

.json-tree .colon {
    color: #333;
    margin-right: 6px;
}

.json-tree .comma {
    color: #999;
}

.json-tree .collapsed-content {
    display: none;
}

.json-tree .toggle.expanded::before {
    content: '▼';
}

.json-tree .toggle:not(.expanded)::before {
    content: '▶';
}

.json-tree-item {
    margin: 2px 0;
}

.json-tree-item.object > .toggle::before {
    content: '{}';
    font-size: 0.9em;
}

.json-tree-item.array > .toggle::before {
    content: '[]';
    font-size: 0.9em;
}

#miniCyGraph {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

[data-theme="dark"] #miniCyGraph {
    background: linear-gradient(135deg, #1a1d21 0%, #22262a 100%);
}

.full-width-card {
    margin-left: calc(-1 * var(--bs-gutter-x) / 2);
    margin-right: calc(-1 * var(--bs-gutter-x) / 2);
    width: calc(100% + var(--bs-gutter-x));
}
</style>
{% endblock %}

{% block content %}
<div class="top-bar">
    <div>
        <h4 class="mb-0">IOC Detail</h4>
        <small class="text-muted">{{ ioc.id }}</small>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" id="versionsBtn" data-bs-toggle="modal" data-bs-target="#versionsModal">
            <i class="bi bi-clock-history me-1"></i> Versions
        </button>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-info" id="enrichBtn">
                <i class="bi bi-search me-1"></i> Enrich
            </button>
            <button type="button" class="btn btn-outline-info dropdown-toggle dropdown-toggle-split" 
                    data-bs-toggle="dropdown" aria-expanded="false" id="enrichDropdown">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" id="enrichMenu" style="min-width: 200px;">
                <li><h6 class="dropdown-header">Enrich with:</h6></li>
                <li><a class="dropdown-item" href="#" onclick="enrichAll(event)">
                    <i class="bi bi-asterisk me-2"></i> All APIs
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li id="apiListContainer">
                    <span class="dropdown-item text-muted small">Loading APIs...</span>
                </li>
            </ul>
        </div>
        <button class="btn btn-outline-danger" id="deleteBtn">
            <i class="bi bi-trash me-1"></i> Delete
        </button>
        <a href="/report?type=ioc&id={{ ioc.id }}" class="btn btn-outline-info" target="_blank">
            <i class="bi bi-file-text me-1"></i> Generate Report
        </a>
        <a href="{{ url_for('main.iocs_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back
        </a>
    </div>
</div>

<div class="row">
    <!-- Main Info -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Indicator Information</h6>
                <span class="ioc-type-badge ioc-type-{{ ioc.x_metadata.ioc_type }}">{{ ioc.x_metadata.ioc_type|upper }}</span>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th width="25%">Value</th>
                        <td><code class="pattern-text">{{ ioc.x_metadata.ioc_value }}</code></td>
                    </tr>
                    <tr>
                        <th>STIX Pattern</th>
                        <td><code class="pattern-text">{{ ioc.pattern }}</code></td>
                    </tr>
                    <tr>
                        <th>Pattern Type</th>
                        <td>{{ ioc.pattern_type }}</td>
                    </tr>
                    <tr>
                        <th>Name</th>
                        <td>{{ ioc.name or '-' }}</td>
                    </tr>
                    <tr>
                        <th>Description</th>
                        <td>{{ ioc.description or '-' }}</td>
                    </tr>
                    <tr>
                        <th>Threat Level</th>
                        <td>
                            <span class="badge bg-{{ 'danger' if ioc.threat_level == 'critical' else 'warning' if ioc.threat_level == 'high' else 'info' if ioc.threat_level == 'medium' else 'secondary' }}">
                                {{ ioc.threat_level|default('Unknown')|title }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>Confidence</th>
                        <td>
                            {% if ioc.confidence %}
                            <span class="badge bg-{{ 'success' if ioc.confidence == 'very-high' else 'info' if ioc.confidence == 'high' else 'warning' if ioc.confidence == 'medium' else 'secondary' }}">
                                {{ ioc.confidence|title }}
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>TLP (Traffic Light Protocol)</th>
                        <td>
                            {% if ioc.tlp %}
                            <span class="badge bg-{{ 'dark' if ioc.tlp == 'red' else 'warning' if ioc.tlp == 'amber' else 'success' if ioc.tlp == 'green' else 'light text-dark' }}">
                                {{ ioc.tlp|upper }}
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Related Campaigns</th>
                        <td>
                            {% for campaign in ioc.campaigns or [] %}
                            <span class="badge bg-light text-dark me-1">{{ campaign }}</span>
                            {% else %}
                            <span class="text-muted">No campaigns</span>
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <th>Labels</th>
                        <td>
                            {% for label in ioc.labels or [] %}
                            <span class="badge bg-light text-dark me-1">{{ label }}</span>
                            {% else %}
                            <span class="text-muted">No labels</span>
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <th>Created</th>
                        <td>{{ ioc.created }}</td>
                    </tr>
                    <tr>
                        <th>Modified</th>
                        <td>{{ ioc.modified or ioc.created }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- Enrichment Information -->
        <div class="card mb-4" id="enrichmentInfoCard" style="display: none;">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-sparkles me-2"></i>Enrichment Information</h6>
                <button class="btn btn-sm btn-outline-secondary edit-enrichment-btn" style="display: none;">
                    <i class="bi bi-pencil me-1"></i> Edit
                </button>
            </div>
            <div class="card-body">
                <div id="enrichmentInfoContent">
                    <p class="text-muted">No enrichment data available</p>
                </div>
            </div>
        </div>
        
        <!-- Enrichment Results -->
        <div class="card mb-4 full-width-card" id="enrichmentCard" style="display: none;">
            <div class="card-header bg-white">
                <h6 class="mb-0">Enrichment Results</h6>
            </div>
            <div class="card-body" id="enrichmentResults">
            </div>
        </div>
        
        <!-- IOC Relationship Graph -->
        <div class="card mb-4" id="iocGraphCard" style="display: none;">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="bi bi-diagram-3 me-2"></i> Relationships Graph
                </h6>
            </div>
            <div class="card-body">
                <div id="miniCyGraph" style="width: 100%; height: 300px; border: 1px solid #ddd; border-radius: 6px;"></div>
            </div>
        </div>
        
        <!-- Related IOCs -->
        <div class="card mb-4" id="relatedIocsCard" style="display: none;">
            <div class="card-header bg-white">
                <h6 class="mb-0">Related IOCs</h6>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="relatedIocsList">
                </ul>
            </div>
        </div>
        
        <!-- Edit Form -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0">Edit Labels & Description</h6>
            </div>
            <div class="card-body">
                <form id="editForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editThreatLevel" class="form-label">Threat Level</label>
                            <select class="form-select" id="editThreatLevel">
                                <option value="unknown" {% if ioc.threat_level == 'unknown' %}selected{% endif %}>Unknown</option>
                                <option value="low" {% if ioc.threat_level == 'low' %}selected{% endif %}>Low</option>
                                <option value="medium" {% if ioc.threat_level == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="high" {% if ioc.threat_level == 'high' %}selected{% endif %}>High</option>
                                <option value="critical" {% if ioc.threat_level == 'critical' %}selected{% endif %}>Critical</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editConfidence" class="form-label">Confidence</label>
                            <select class="form-select" id="editConfidence">
                                <option value="" {% if not ioc.confidence %}selected{% endif %}>Select confidence...</option>
                                <option value="low" {% if ioc.confidence == 'low' %}selected{% endif %}>Low (0-30%)</option>
                                <option value="medium" {% if ioc.confidence == 'medium' %}selected{% endif %}>Medium (30-70%)</option>
                                <option value="high" {% if ioc.confidence == 'high' %}selected{% endif %}>High (70-90%)</option>
                                <option value="very-high" {% if ioc.confidence == 'very-high' %}selected{% endif %}>Very High (90-100%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editTlp" class="form-label">TLP (Traffic Light Protocol)</label>
                            <select class="form-select" id="editTlp">
                                <option value="" {% if not ioc.tlp %}selected{% endif %}>Select TLP level...</option>
                                <option value="white" {% if ioc.tlp == 'white' %}selected{% endif %}>White - Unrestricted</option>
                                <option value="green" {% if ioc.tlp == 'green' %}selected{% endif %}>Green - Community</option>
                                <option value="amber" {% if ioc.tlp == 'amber' %}selected{% endif %}>Amber - Limited</option>
                                <option value="red" {% if ioc.tlp == 'red' %}selected{% endif %}>Red - Restricted</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCampaigns" class="form-label">Related Campaigns</label>
                            <input type="text" class="form-control" id="editCampaigns" 
                                   value="{{ (ioc.campaigns or [])|join(', ') }}"
                                   placeholder="Comma-separated campaigns">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editValidFrom" class="form-label">Valid From</label>
                        <input type="datetime-local" class="form-control" id="editValidFrom" 
                               value="{% if ioc.valid_from %}{{ ioc.valid_from[:16] }}{% endif %}">
                        <div class="form-text">Indicator validity start date (STIX)</div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editAddValidUntil" 
                               {% if ioc.valid_until %}checked{% endif %} 
                               onchange="toggleEditValidUntil()">
                        <label class="form-check-label" for="editAddValidUntil">
                            Add expiration date
                        </label>
                    </div>

                    <div id="editValidUntilWrapper" {% if not ioc.valid_until %}style="display: none; margin-left: 20px;"{% else %}style="margin-left: 20px;"{% endif %}>
                        <div class="mb-3">
                            <label for="editValidUntil" class="form-label">Valid Until</label>
                            <input type="datetime-local" class="form-control" id="editValidUntil" 
                                   value="{% if ioc.valid_until %}{{ ioc.valid_until[:16] }}{% endif %}">
                            <div class="form-text">Indicator validity end date (STIX)</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editLabels" class="form-label">Labels</label>
                        <input type="text" class="form-control" id="editLabels" 
                               value="{{ (ioc.labels or [])|join(', ') }}"
                               placeholder="Comma-separated labels">
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" rows="3">{{ ioc.description or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Save Changes
                    </button>
                </form>
            </div>
        </div>

        <!-- Create Relation -->
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0">Create Relation</h6>
            </div>
            <div class="card-body">
                <form id="createRelationForm">
                    <div class="mb-3">
                        <label for="relationIOC" class="form-label">Related IOC</label>
                        <input type="text" class="form-control" id="relationIOC" 
                               placeholder="Search IOC value or click to select"
                               autocomplete="off">
                        <div class="dropdown-menu" id="iocSearchDropdown" style="display: none; width: 100%; max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="relationType" class="form-label">Relation Type</label>
                        <select class="form-select" id="relationType" required>
                            <option value="">-- Select relation type --</option>
                            <option value="related-to">Related To</option>
                            <option value="indicates">Indicates</option>
                            <option value="resolves-to">Resolves To</option>
                            <option value="located-at">Located At</option>
                            <option value="communicates-with">Communicates With</option>
                            <option value="uses">Uses</option>
                            <option value="attributed-to">Attributed To</option>
                            <option value="exploits">Exploits</option>
                            <option value="based-on">Based On</option>
                            <option value="created-by">Created By</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-link-45deg me-1"></i> Create Relation
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sources -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0">Sources ({{ (ioc.sources or [])|length }})</h6>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for source in ioc.sources or [] %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ source.name }}</strong>
                                <br>
                                <small class="text-muted">{{ source.timestamp[:19] if source.timestamp else 'N/A' }}</small>
                            </div>
                            <span class="badge bg-secondary">{{ loop.index }}</span>
                        </div>
                        {% if source.metadata %}
                        <div class="mt-2">
                            <small class="text-muted">
                                {% for key, value in source.metadata.items() %}
                                {{ key }}: {{ value }}<br>
                                {% endfor %}
                            </small>
                        </div>
                        {% endif %}
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted">No sources recorded</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <!-- STIX JSON -->
        <div class="card mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">STIX JSON</h6>
                <button class="btn btn-sm btn-outline-secondary" id="copyStixBtn">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>
            <div class="card-body">
                <pre class="mb-0" style="max-height: 300px; overflow: auto; font-size: 0.75rem;" id="stixJson">{{ ioc|tojson(indent=2) }}</pre>
            </div>
        </div>
    </div>
</div>

<!-- Version History Modal -->
<div class="modal fade" id="versionsModal" tabindex="-1" aria-labelledby="versionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="versionsModalLabel">
                    <i class="bi bi-clock-history me-2"></i>Version History
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="versionsLoading" class="text-center py-4">
                    <span class="spinner-border spinner-border-sm me-2"></span> Loading versions...
                </div>
                <div id="versionsContent" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Current Version:</strong> <span id="currentVersionNumber">-</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Version</th>
                                    <th>Modified</th>
                                    <th>Modified By</th>
                                    <th>Changes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="versionsTableBody">
                            </tbody>
                        </table>
                    </div>
                    <nav id="versionsPagination" aria-label="Version pagination" style="display: none;">
                        <ul class="pagination justify-content-center">
                        </ul>
                    </nav>
                </div>
                <div id="versionsEmpty" style="display: none;" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox me-2" style="font-size: 2rem;"></i>
                    <p>No previous versions found</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Version Detail Modal -->
<div class="modal fade" id="versionDetailModal" tabindex="-1" aria-labelledby="versionDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="versionDetailModalLabel">Version Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="versionDetailContent">
                    <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow: auto;" id="versionJson"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="restoreVersionBtn">
                    <i class="bi bi-arrow-counterclockwise me-1"></i> Restore This Version
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.29.2/cytoscape.min.js"></script>
<script>
const iocId = '{{ ioc.id }}';
const iocValue = '{{ ioc.ioc_value or ioc.x_metadata.ioc_value }}';
const iocType = '{{ ioc.ioc_type or ioc.x_metadata.ioc_type }}';

// Enrichment data passed from backend
const enrichmentData = {% if enrichment_data %}{{ enrichment_data | tojson }}{% else %}null{% endif %};

// Helper function to escape HTML

// Load available APIs for enrichment dropdown
function loadAvailableAPIs() {
    $.ajax({
        url: '/api/external-apis',
        method: 'GET',
        success: function(data) {
            const container = $('#apiListContainer');
            container.empty();
            
            if (!data.configs || data.configs.length === 0) {
                container.html('<span class="dropdown-item text-muted small">No APIs configured</span>');
                return;
            }
            
            data.configs.forEach(api => {
                if (api.enabled) {
                    container.append(`
                        <li><a class="dropdown-item" href="#" onclick="enrichWithAPI('${api.id}', '${escapeHtml(api.name)}', event)">
                            <i class="bi bi-lightning-fill me-2"></i> ${escapeHtml(api.name)}
                        </a></li>
                    `);
                }
            });
        }
    });
}

function enrichAll(event) {
    event.preventDefault();
    performEnrich();
}

function enrichWithAPI(apiId, apiName, event) {
    event.preventDefault();
    performEnrich([apiId]);
}

// Display enrichment results with field selection checkboxes
function displayEnrichmentWithSelection(results) {
    const card = $('#enrichmentCard');
    const container = $('#enrichmentResults');
    
    if (!card.length || !container.length) {
        console.error('Enrichment card or container not found');
        return;
    }
    
    container.empty();
    
    results.forEach((result, index) => {
        const apiName = result.api_name || 'Unknown API';
        const apiId = result.api_id || 'unknown';
        const rawResponse = result.raw_response || {};
        
        // Create field list from raw_response
        const fields = Object.keys(rawResponse).filter(key => {
            // Skip internal/metadata fields
            return !key.startsWith('_') && !['id', 'type', 'api_name', 'api_id', 'enriched_at', 'enriched_by'].includes(key);
        });
        
        // Create field selection panel
        let fieldCheckboxes = '';
        if (fields.length > 0) {
            fieldCheckboxes = fields.map(field => {
                const value = rawResponse[field];
                const displayValue = typeof value === 'object' 
                    ? JSON.stringify(value).substring(0, 50) + '...'
                    : String(value).substring(0, 50);
                
                return `
                    <div class="form-check">
                        <input class="form-check-input enrich-field-checkbox" type="checkbox" 
                               id="field_${index}_${field}" 
                               data-index="${index}" data-field="${field}" 
                               value="${escapeHtml(displayValue)}">
                        <label class="form-check-label" for="field_${index}_${field}">
                            <strong>${escapeHtml(field)}</strong>: 
                            <small class="text-muted">${escapeHtml(displayValue)}</small>
                        </label>
                    </div>
                `;
            }).join('');
        } else {
            fieldCheckboxes = '<p class="text-muted small">No fields available to select</p>';
        }
        
        // Encode raw response for later retrieval
        const rawResponseEncoded = btoa(JSON.stringify(rawResponse));
        
        const statusIcon = result.success ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>';
        const cacheInfo = result.from_cache ? '<span class="badge bg-secondary">Cached</span>' : '<span class="badge bg-primary">Live</span>';
        
        const panelHtml = `
            <div class="card mb-3 enrichment-result" data-index="${index}" data-raw-response-encoded="${rawResponseEncoded}" data-api-id="${apiId}" data-api-name="${escapeHtml(apiName)}">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${statusIcon}
                            <strong class="ms-2">${escapeHtml(apiName)}</strong>
                            ${cacheInfo}
                        </div>
                        <small class="text-muted">${result.success ? fields.length + ' fields' : 'Failed'}</small>
                    </div>
                </div>
                <div class="card-body">
                    ${result.success ? `
                        <p class="mb-3"><small class="text-muted">Select fields to store in IOC enrichment:</small></p>
                        <div class="field-selection">
                            ${fieldCheckboxes}
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-primary store-selected-fields-btn" 
                                    data-index="${index}" 
                                    data-api-name="${escapeHtml(apiName)}" 
                                    data-api-id="${apiId}">
                                <i class="bi bi-check2 me-1"></i> Store Selected Fields
                            </button>
                        </div>
                    ` : `
                        <p class="text-danger"><small>Enrichment failed. Check API configuration and try again.</small></p>
                    `}
                </div>
            </div>
        `;
        
        container.append(panelHtml);
    });
    
    card.show();
}

// Handle storing selected fields
$(document).on('click', '.store-selected-fields-btn', function(e) {
    e.preventDefault();
    
    const btn = $(this);
    const index = btn.data('index');
    const apiName = btn.data('api-name');
    const apiId = btn.data('api-id');
    
    const enrichmentPanel = $(`.enrichment-result[data-index="${index}"]`);
    const rawResponseEncoded = enrichmentPanel.data('raw-response-encoded');
    
    if (!rawResponseEncoded) {
        showAlert('No raw response data available', 'warning');
        return;
    }
    
    // Decode raw response
    let rawResponse;
    try {
        rawResponse = JSON.parse(atob(rawResponseEncoded));
    } catch(err) {
        showAlert('Failed to parse raw response data', 'danger');
        return;
    }
    
    // Get selected fields
    const selectedFields = {};
    $(`.enrich-field-checkbox[data-index="${index}"]:checked`).each(function() {
        const field = $(this).data('field');
        if (field in rawResponse) {
            selectedFields[field] = rawResponse[field];
        }
    });
    
    if (Object.keys(selectedFields).length === 0) {
        showAlert('Please select at least one field', 'warning');
        return;
    }
    
    // Send to store-enrichment endpoint
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Storing...');
    
    $.ajax({
        url: `/api/ioc/${iocId}/store-enrichment`,
        method: 'POST',
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({
            api_name: apiName,
            api_id: apiId,
            selected_fields: selectedFields
        }),
        success: function(response) {
            showAlert(`Stored ${Object.keys(selectedFields).length} fields from ${apiName}`, 'success');
            
            // Reload page to show updated enrichment
            setTimeout(() => location.reload(), 1500);
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'Unknown error';
            showAlert('Failed to store enrichment: ' + errorMsg, 'danger');
            btn.prop('disabled', false).html('<i class="bi bi-check2 me-1"></i> Store Selected Fields');
        }
    });
});

function performEnrich(apiIds = null) {
    const btn = $('#enrichBtn');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Enriching...');
    
    const payload = {};
    
    if (apiIds && apiIds.length > 0) {
        payload.api_ids = apiIds;
    }
    
    console.log('Enriching IOC with payload:', payload);
    
    $.ajax({
        url: `/api/ioc/${iocId}/enrich`,  // Note: /api/ioc (singular), not /api/iocs
        method: 'POST',
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify(payload),
        timeout: 120000,  // Increased to 120 seconds to account for slow APIs
        success: function(data) {
            console.log('Enrichment success:', data);
            
            // New endpoint returns: {value, type, results}
            // results is array of {api_name, api_id, success, from_cache, raw_response, transformed}
            if (data.results && data.results.length > 0) {
                // Display raw results with field selection UI
                displayEnrichmentWithSelection(data.results);
                showAlert('Enrichment completed. Select fields to store.', 'info');
            } else {
                showAlert('Enrichment completed but no results to display', 'info');
            }
            
            btn.prop('disabled', false).html('<i class="bi bi-search me-1"></i> Enrich');
        },
        error: function(xhr, status, error) {
            console.error('Enrichment error:', status, error, xhr.responseText);
            const errorMsg = xhr.responseJSON?.error || error || 'Unknown error';
            showAlert('Enrichment failed: ' + errorMsg, 'danger');
            btn.prop('disabled', false).html('<i class="bi bi-search me-1"></i> Enrich');
        }
    });
}

    // Load APIs when page loads
$(document).ready(function() {
    loadAvailableAPIs();
    
    // Display existing enrichment data if available
    if (enrichmentData && enrichmentData.api_results && enrichmentData.api_results.length > 0) {
        // Transform existing enrichment data to match the format expected by displayEnrichment
        const results = enrichmentData.api_results.map((result, index) => ({
            api_name: result.api_name || 'Unknown API',
            api_id: result.api_id || '',
            success: true,
            from_cache: true,  // Mark as stored data
            raw_response: result,
            transformed: {}  // No transformation needed for stored data
        }));
        displayEnrichment(results);
        
        // Show enrichment info card
        const enrichmentInfoCard = $('#enrichmentInfoCard');
        const enrichmentInfoContent = $('#enrichmentInfoContent');
        enrichmentInfoContent.html(`
            <p><small class="text-muted">
                <i class="bi bi-info-circle me-2"></i>
                Enriched on <strong>${enrichmentData.enriched_at || 'Unknown'}</strong> 
                by <strong>${enrichmentData.enriched_by || 'Unknown'}</strong>
            </small></p>
        `);
        enrichmentInfoCard.show();
    }
    
    // Import enrichment data button handler (delegated)
    $(document).on('click', '.import-enrichment-btn', function(e) {
        e.preventDefault();
        const encodedData = $(this).data('enrichment');
        const transformedData = JSON.parse(atob(encodedData)); // Decode from base64
        importEnrichmentData(transformedData);
    });
    
    // Handle adding selected fields from raw response
    $(document).on('click', '.add-selected-fields-btn', function(e) {
        e.preventDefault();
        
        const index = $(this).data('index');
        const enrichmentPanel = $(`.enrichment-result[data-index="${index}"]`);
        const rawResponseEncoded = enrichmentPanel.data('raw-response-encoded');
        
        if (!rawResponseEncoded) {
            showAlert('No raw response data available', 'warning');
            return;
        }
        
        // Decode raw response from base64
        let rawResponse;
        try {
            rawResponse = JSON.parse(atob(rawResponseEncoded));
        } catch(err) {
            showAlert('Failed to parse raw response data', 'danger');
            return;
        }
        
        // Actually get selected from all checkboxes with correct selector
        const selectedFieldsActual = $(`.field-picker-checkbox[data-index="${index}"]:checked`)
            .map(function() {
                return $(this).data('field');
            }).get();
        
        if (selectedFieldsActual.length === 0) {
            showAlert('Please select at least one field', 'warning');
            return;
        }
        
        // Build updates object with selected fields
        const updates = {};
        selectedFieldsActual.forEach(field => {
            if (field in rawResponse) {
                const value = rawResponse[field];
                // Store as enrichment_* field if not a standard IOC field
                const fieldName = 'enrichment_' + field;
                updates[fieldName] = value;
            }
        });
        
        if (Object.keys(updates).length === 0) {
            showAlert('Selected fields not found in raw response', 'warning');
            return;
        }
        
        // Send PATCH request to update IOC
        $.ajax({
            url: `/api/ioc/${iocId}`,
            method: 'PATCH',
            data: JSON.stringify(updates),
            contentType: 'application/json',
            success: function(response) {
                showAlert(`Added ${Object.keys(updates).length} fields to IOC`, 'success');
                setTimeout(() => location.reload(), 1500);
            },
            error: function(xhr) {
                showAlert('Failed to add fields: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
            }
        });
    });
    
    // Delete button handler
    $('#deleteBtn').click(function(e) {
        e.preventDefault();
        
        if (!confirm('Are you sure you want to delete this IOC? This action cannot be undone.')) {
            return;
        }
        
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Deleting...');
        
        $.ajax({
            url: `/api/ioc/${iocId}`,
            method: 'DELETE',
            success: function() {
                showAlert('IOC deleted successfully', 'success');
                setTimeout(() => window.location.href = '/iocs', 1000);
            },
            error: function(xhr) {
                showAlert('Failed to delete IOC: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
                btn.prop('disabled', false).html('<i class="bi bi-trash me-1"></i> Delete');
            }
        });
    });
});

function displayEnrichment(results) {
    const card = $('#enrichmentCard');
    const container = $('#enrichmentResults');
    container.empty();
    
    if (!results || results.length === 0) {
        container.html('<p class="text-muted">No external APIs configured. <a href="/settings/external-apis">Configure APIs</a></p>');
        card.show();
        return;
    }
    
    results.forEach((result, index) => {
        const rawResponseJSON = btoa(JSON.stringify(result.raw_response || {})); // Base64 encode raw response
        let html = `<div class="border rounded p-3 mb-3 enrichment-result" data-index="${index}" data-raw-response-encoded="${rawResponseJSON}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">${result.api_name}</h6>
                <div>`;
        
        if (result.from_cache) {
            html += '<small class="text-muted me-2"><i class="bi bi-clock"></i> From cache</small>';
        }
        
        // Add import button if there's transformed data
        if (result.success && result.transformed && Object.keys(result.transformed).length > 0) {
            const dataAttr = btoa(JSON.stringify(result.transformed)); // Base64 encode to avoid escaping issues
            html += `<button class="btn btn-sm btn-outline-success import-enrichment-btn" data-enrichment="${dataAttr}">
                <i class="bi bi-download me-1"></i> Import Data
            </button>`;
        }
        
        html += '</div></div>';
        
        if (result.success) {
            // Raw response in accordion with field picker
            if (result.raw_response && Object.keys(result.raw_response).length > 0) {
                const rawId = `raw-${index}-${Date.now()}`;
                const pickerId = `picker-${index}-${Date.now()}`;
                
                // Get all top-level fields from raw response (excluding nested objects)
                const topLevelFields = Object.keys(result.raw_response)
                    .filter(key => !key.startsWith('_') && key !== 'raw_response')
                    .sort();
                
                html += `<div class="accordion mt-3" id="accordion-${index}">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${rawId}" aria-expanded="false">
                                <i class="bi bi-plus-circle me-2"></i> Pick Fields to Enrich IOC
                            </button>
                        </h2>
                        <div id="${rawId}" class="accordion-collapse collapse" data-bs-parent="#accordion-${index}">
                            <div class="accordion-body">
                                <div class="row">
                                    <!-- Field Picker -->
                                    <div class="col-md-4">
                                        <h6 class="mb-3"><i class="bi bi-hand-index me-2"></i>Select Fields to Add</h6>
                                        <div id="${pickerId}" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                                            ${topLevelFields.map(field => `
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input field-picker-checkbox" type="checkbox" id="field-${field}-${index}" data-field="${field}" data-index="${index}">
                                                    <label class="form-check-label" for="field-${field}-${index}" style="cursor: pointer; word-break: break-word;">
                                                        <small>${field}</small>
                                                    </label>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <button class="btn btn-sm btn-primary mt-2 w-100 add-selected-fields-btn" data-index="${index}">
                                            <i class="bi bi-plus-circle me-1"></i> Add Selected Fields
                                        </button>
                                    </div>
                                    
                                    <!-- Raw Response JSON -->
                                    <div class="col-md-8">
                                        <h6 class="mb-3"><i class="bi bi-braces me-2"></i>Full API Response</h6>
                                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; margin: 0; max-height: 400px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(result.raw_response, null, 2))}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        } else {
            html += `<p class="text-danger mb-0"><strong>Error:</strong> ${escapeHtml(result.error)}</p>`;
        }
        
        html += '</div>';
        container.append(html);
    });
    
    card.show();
}

function importEnrichmentData(transformedData) {
    // Map transformed data to IOC fields
    const updates = {};
    
    // Standard IOC fields to import (both direct and enrichment)
    const fieldMapping = {
        'name': 'name',
        'description': 'description',
        'labels': 'labels',
        'threat_level': 'threat_level',
        'confidence': 'confidence',
        'tlp': 'tlp',
        'risk_score': 'risk_score',
        'severity': 'severity',
        'reputation': 'reputation',
        'malware_family': 'malware_family',
        'country': 'country',
        'asn': 'asn',
        'registrar': 'registrar',
        'last_seen': 'last_seen',
        'first_seen': 'first_seen',
        'detection_ratio': 'detection_ratio',
        'attributes': 'attributes',
        'metadata': 'metadata'
    };
    
    // Import known fields
    Object.entries(fieldMapping).forEach(([apiField, iocField]) => {
        if (apiField in transformedData) {
            updates[iocField] = transformedData[apiField];
        }
    });
    
    // Import unmapped fields as enrichment_* fields
    Object.entries(transformedData).forEach(([key, value]) => {
        if (!fieldMapping[key] && !Object.values(fieldMapping).includes(key)) {
            // Store as enrichment field
            updates[`enrichment_${key}`] = value;
        }
    });
    
    if (Object.keys(updates).length === 0) {
        showAlert('No mappable data found in enrichment result', 'warning');
        return;
    }
    
    // Send update to API
    $.ajax({
        url: `/api/ioc/${iocId}`,
        method: 'PATCH',
        data: JSON.stringify(updates),
        contentType: 'application/json',
        success: function(response) {
            showAlert('IOC updated with enrichment data (' + Object.keys(updates).length + ' fields)', 'success');
            // Reload the page to show updated data
            setTimeout(() => location.reload(), 1500);
        },
        error: function(xhr) {
            showAlert('Failed to import enrichment data: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
        }
    });
}

function jsonToTree(obj, key = null, isRoot = false) {
    if (obj === null) {
        return `<span class="null">null</span>`;
    }
    
    if (typeof obj === 'boolean') {
        return `<span class="boolean">${obj}</span>`;
    }
    
    if (typeof obj === 'number') {
        return `<span class="number">${obj}</span>`;
    }
    
    if (typeof obj === 'string') {
        // Truncate very long strings
        const displayStr = obj.length > 150 ? obj.substring(0, 150) + '...' : obj;
        return `<span class="string">${escapeHtml(displayStr)}</span>`;
    }
    
    if (Array.isArray(obj)) {
        if (obj.length === 0) {
            return '<span class="bracket">[ ]</span> <span class="null" style="opacity: 0.7; font-size: 0.85em;">empty</span>';
        }
        
        let html = '<span class="bracket">[</span>';
        html += '<ul class="collapsed-content" style="display: block;">';
        
        obj.forEach((item, index) => {
            html += `<li class="json-tree-item array">`;
            
            // Add toggle for nested objects/arrays
            if ((typeof item === 'object' && item !== null && 
                ((Array.isArray(item) && item.length > 0) || Object.keys(item).length > 0))) {
                html += '<span class="toggle expanded"></span>';
            } else {
                html += '<span style="display: inline-block; width: 20px;"></span>';
            }
            
            html += '<span style="color: #999; margin-right: 8px;">[' + index + ']</span>';
            html += jsonToTree(item, index);
            
            if (index < obj.length - 1) html += '<span class="comma">,</span>';
            html += '</li>';
        });
        
        html += '</ul>';
        html += '<span class="bracket">]</span>';
        return html;
    }
    
    if (typeof obj === 'object') {
        const keys = Object.keys(obj);
        if (keys.length === 0) {
            return '<span class="bracket">{ }</span> <span class="null" style="opacity: 0.7; font-size: 0.85em;">empty</span>';
        }
        
        let html = '<span class="bracket">{</span>';
        html += '<ul class="collapsed-content" style="display: block;">';
        
        keys.forEach((k, index) => {
            const val = obj[k];
            const hasChildren = (typeof val === 'object' && val !== null && 
                ((Array.isArray(val) && val.length > 0) || Object.keys(val).length > 0));
            
            html += `<li class="json-tree-item ${Array.isArray(val) ? 'array' : 'object'}">`;
            
            // Add toggle if value has children
            if (hasChildren) {
                html += '<span class="toggle expanded"></span>';
            } else {
                html += '<span style="display: inline-block; width: 20px;"></span>';
            }
            
            html += `<span class="key">${escapeHtml(k)}</span><span class="colon">:</span>`;
            
            if (hasChildren) {
                html += '<ul class="collapsed-content" style="display: block;">';
                html += '<li style="padding-left: 0;">' + jsonToTree(val, k) + '</li>';
                html += '</ul>';
            } else {
                html += jsonToTree(val, k);
            }
            
            if (index < keys.length - 1) html += '<span class="comma">,</span>';
            html += '</li>';
        });
        
        html += '</ul>';
        html += '<span class="bracket">}</span>';
        return html;
    }
    
    return String(obj);
}

$('#copyStixBtn').click(function() {
    const stixJson = $('#stixJson').text();
    navigator.clipboard.writeText(stixJson).then(() => {
        showAlert('Copied to clipboard', 'success');
    });
});

// Load related IOCs
function loadRelatedIOCs() {
    $.ajax({
        url: `/api/ioc/${iocId}/relations`,
        method: 'GET',
        success: function(response) {
            const relatedIOCs = response.related_iocs || [];
            
            if (relatedIOCs.length > 0) {
                const card = $('#relatedIocsCard');
                const list = $('#relatedIocsList');
                list.empty();
                
                relatedIOCs.forEach(ioc => {
                    list.append(`
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong><a href="/iocs/${ioc.id}">${ioc.ioc_value}</a></strong>
                                    <br>
                                    <small class="text-muted">
                                        <span class="ioc-type-badge ioc-type-${ioc.ioc_type}">${(ioc.ioc_type || '').toUpperCase()}</span>
                                        ${ioc.relation_type ? ` • ${ioc.relation_type}` : ''}
                                    </small>
                                </div>
                            </div>
                        </li>
                    `);
                });
                
                card.show();
            }
        },
        error: function() {
            console.log('Failed to load related IOCs');
        }
    });
}

// Load related IOCs on page load
$(document).ready(function() {
    loadRelatedIOCs();
    
    // Edit form submission
    $('#editForm').submit(function(e) {
        e.preventDefault();
        
        const updateData = {
            threat_level: $('#editThreatLevel').val(),
            confidence: $('#editConfidence').val() || null,
            tlp: $('#editTlp').val() || null,
            campaigns: $('#editCampaigns').val().split(',').map(c => c.trim()).filter(c => c),
            labels: $('#editLabels').val().split(',').map(l => l.trim()).filter(l => l),
            description: $('#editDescription').val(),
            valid_from: $('#editValidFrom').val() ? new Date($('#editValidFrom').val()).toISOString() : null,
            valid_until: $('#editValidUntil').val() ? new Date($('#editValidUntil').val()).toISOString() : null
        };
        
        $.ajax({
            url: `/api/ioc/${iocId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(updateData),
            success: function() {
                showAlert('IOC updated successfully', 'success');
                setTimeout(() => location.reload(), 500);
            },
            error: function(xhr) {
                showAlert('Failed to update IOC: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
            }
        });
    });
    
    // IOC search for creating relations
    $('#relationIOC').on('input', function() {
        const query = $(this).val().trim();
        const dropdown = $('#iocSearchDropdown');
        
        if (query.length < 2) {
            dropdown.hide();
            return;
        }
        
        $.ajax({
            url: '/api/search',
            method: 'GET',
            data: { q: query },
            success: function(response) {
                dropdown.empty();
                const iocs = response.results || response.items || [];
                
                if (iocs.length === 0) {
                    dropdown.html('<div class="dropdown-item text-muted">No IOCs found</div>');
                } else {
                    iocs.forEach(ioc => {
                        if (ioc.id !== iocId) { // Don't allow self-relation
                            dropdown.append(`
                                <div class="dropdown-item" style="cursor: pointer;" data-ioc-id="${ioc.id}" data-ioc-value="${ioc.ioc_value || ioc.value}">
                                    <strong>${ioc.ioc_value || ioc.value}</strong>
                                    <br>
                                    <small class="text-muted">${ioc.ioc_type || ioc.type}</small>
                                </div>
                            `);
                        }
                    });
                }
                
                dropdown.show();
            }
        });
    });
    
    // Handle IOC selection from dropdown
    $(document).on('click', '#iocSearchDropdown .dropdown-item', function() {
        const iocId = $(this).data('ioc-id');
        const iocValue = $(this).data('ioc-value');
        $('#relationIOC').val(iocValue).data('selected-id', iocId);
        $('#iocSearchDropdown').hide();
    });
    
    // Create relation form submission
    $('#createRelationForm').submit(function(e) {
        e.preventDefault();
        
        const selectedId = $('#relationIOC').data('selected-id');
        const relationType = $('#relationType').val();
        
        if (!selectedId) {
            showAlert('Please select a valid IOC', 'warning');
            return;
        }
        
        if (!relationType) {
            showAlert('Please select a relation type', 'warning');
            return;
        }
        
        $.ajax({
            url: `/api/ioc/${iocId}/relations`,
            method: 'POST',
            data: JSON.stringify({
                related_ioc_id: selectedId,
                relation_type: relationType
            }),
            success: function() {
                showAlert('Relation created successfully', 'success');
                document.getElementById('createRelationForm').reset();
                $('#relationIOC').removeData('selected-id');
                loadRelatedIOCs();
            },
            error: function(xhr) {
                showAlert('Failed to create relation: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
            }
        });
    });

    // Load and initialize relationship graph
    let miniCy = null;

    function toggleEditValidUntil() {
        const checkbox = $('#editAddValidUntil');
        const wrapper = $('#editValidUntilWrapper');
        const input = $('#editValidUntil');
        
        if (checkbox.is(':checked')) {
            wrapper.show();
        } else {
            wrapper.hide();
            input.val(''); // Clear the value when unchecked
        }
    }

    function initMiniGraph(nodes, edges) {
        if (miniCy) {
            miniCy.destroy();
        }

        miniCy = cytoscape({
            container: document.getElementById('miniCyGraph'),
            elements: { nodes: nodes, edges: edges },
            style: [
                {
                    selector: 'node',
                    style: {
                        'content': 'data(label)',
                        'background-color': 'data(color)',
                        'width': 40,
                        'height': 40,
                        'border-width': 2,
                        'border-color': '#333',
                        'font-size': 10,
                        'color': 'white',
                        'text-outline-width': 1,
                        'text-outline-color': '#333',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'padding': 3
                    }
                },
                {
                    selector: 'node[id="' + iocId + '"]',
                    style: {
                        'border-width': 3,
                        'border-color': '#FFD700',
                        'width': 50,
                        'height': 50
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'line-color': '#999',
                        'target-arrow-color': '#999',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'width': 2,
                        'opacity': 0.8,
                        'font-size': 8,
                        'color': '#333',
                        'content': 'data(label)',
                        'text-background-color': '#fff',
                        'text-background-opacity': 0.8,
                        'text-background-padding': '2px'
                    }
                }
            ],
            layout: {
                name: 'cose',
                animate: true,
                animationDuration: 400,
                randomize: false,
                nodeSpacing: 30,
                padding: 40,
                fit: true,
                directed: true,
                avoidOverlap: true,
                avoidOverlapPadding: 10,
                minNodeSpacing: 40
            },
            wheelSensitivity: 0.1,
            minZoom: 0.5,
            maxZoom: 2
        });

        // Attendre que le layout soit fini pour bien centrer
        setTimeout(function() {
            if (miniCy && miniCy.elements().length > 0) {
                miniCy.fit(miniCy.elements(), 40);
                miniCy.center();
            }
        }, 500);

        // Click on node to navigate to IOC
        miniCy.on('tap', 'node', function(e) {
            const nodeId = e.target.id();
            if (nodeId !== iocId) {
                window.location.href = `/iocs/${nodeId}`;
            }
        });
    }

    function loadIOCGraph() {
        $.ajax({
            url: `/api/iocs/${iocId}/graph-data`,
            method: 'GET',
            success: function(response) {
                const nodes = response.nodes;
                const edges = response.edges;

                // Add colors
                nodes.forEach(node => {
                    const type = node.data.type.replace('-', '_');
                    node.data.color = getColorForType(type);
                });

                if (nodes.length > 1) {
                    initMiniGraph(nodes, edges);
                    document.getElementById('iocGraphCard').style.display = 'block';
                }
            },
            error: function() {
                console.log('No related IOCs for graph');
            }
        });
    }

    function getColorForType(type) {
        const colors = {
            'ipv4': '#FF6B6B',
            'ipv6': '#FF5252',
            'domain': '#4ECDC4',
            'email': '#95E1D3',
            'url': '#FFE66D',
            'md5': '#A8E6CF',
            'sha1': '#FFD3B6',
            'sha256': '#FFAAA5',
            'asn': '#C7CEEA',
            'file_path': '#FF8B94',
            'process_name': '#FFA07A',
            'registry_key': '#DDA0DD',
            'windows_registry_key': '#BA55D3',
            'mutex': '#9370DB',
            'certificate_serial': '#87CEEB'
        };
        return colors[type] || '#888';
    }

    // Load graph on page load
    $(document).ready(function() {
        loadIOCGraph();
        loadEnrichmentInfo();
    });
    
    // Load and display enrichment information
    function loadEnrichmentInfo() {
        const enrichmentFields = {};
        const iocData = {
            'name': '{{ ioc.get("name", "") }}',
            'description': '{{ ioc.get("description", "") }}',
            'labels': {{ ioc.get('labels', [])|tojson }},
            'threat_level': '{{ ioc.get("threat_level", "") }}',
            'confidence': '{{ ioc.get("confidence", "") }}',
            'tlp': '{{ ioc.get("tlp", "") }}',
            'risk_score': '{{ ioc.get("risk_score", "") }}',
            'severity': '{{ ioc.get("severity", "") }}',
            'reputation': '{{ ioc.get("reputation", "") }}',
            'malware_family': '{{ ioc.get("malware_family", "") }}',
            'country': '{{ ioc.get("country", "") }}',
            'asn': '{{ ioc.get("asn", "") }}',
            'registrar': '{{ ioc.get("registrar", "") }}',
            'last_seen': '{{ ioc.get("last_seen", "") }}',
            'first_seen': '{{ ioc.get("first_seen", "") }}',
            'detection_ratio': '{{ ioc.get("detection_ratio", "") }}',
            'attributes': {{ ioc.get('attributes', {})|tojson }},
            'metadata': {{ ioc.get('metadata', {})|tojson }}
        };
        
        // Collect all enrichment_* fields
        const allFields = {{ ioc|tojson|safe }};
        for (const [key, value] of Object.entries(allFields)) {
            if (key.startsWith('enrichment_')) {
                const fieldName = key.replace('enrichment_', '');
                enrichmentFields[fieldName] = value;
            }
        }
        
        if (Object.keys(enrichmentFields).length === 0) {
            $('#enrichmentInfoCard').hide();
            return;
        }
        
        // Display enrichment fields
        let html = '<table class="table table-borderless mb-0">';
        Object.entries(enrichmentFields).forEach(([key, value]) => {
            const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value || '-');
            const truncated = displayValue.length > 200 ? displayValue.substring(0, 200) + '...' : displayValue;
            html += `<tr class="enrichment-row" data-field="${key}">
                <th width="25%">
                    <span class="enrichment-field-name">${escapeHtml(key)}</span>
                    <button class="btn btn-xs btn-link rename-enrichment-field" data-field="${key}" style="padding: 0; font-size: 0.8rem;">
                        <i class="bi bi-pencil"></i>
                    </button>
                </th>
                <td>
                    <code class="enrichment-field-value">${escapeHtml(truncated)}</code>
                </td>
            </tr>`;
        });
        html += '</table>';
        
        $('#enrichmentInfoContent').html(html);
        $('#enrichmentInfoCard').show();
    }
    
    // Rename enrichment field
    $(document).on('click', '.rename-enrichment-field', function(e) {
        e.preventDefault();
        const field = $(this).data('field');
        const row = $(`.enrichment-row[data-field="${field}"]`);
        const fieldNameSpan = row.find('.enrichment-field-name');
        const currentName = fieldNameSpan.text();
        
        const newName = prompt('Enter new field name:', currentName);
        if (newName && newName !== currentName) {
            const updates = {};
            // Get the current value
            const currentValue = window.iocData && window.iocData['enrichment_' + field];
            
            // If renaming, we need to:
            // 1. Add the new field name with the value
            // 2. Remove the old field name
            updates['enrichment_' + newName] = currentValue;
            // Mark old field for deletion by setting to null
            updates['enrichment_' + field] = null;
            
            $.ajax({
                url: `/api/ioc/${iocId}`,
                method: 'PATCH',
                data: JSON.stringify(updates),
                contentType: 'application/json',
                success: function(response) {
                    showAlert(`Field renamed from "${currentName}" to "${newName}"`, 'success');
                    setTimeout(() => location.reload(), 1500);
                },
                error: function(xhr) {
                    showAlert('Failed to rename field: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
                }
            });
        }
    });
});

// ========================================
// VERSION HISTORY FUNCTIONS
// ========================================

let currentVersionsPage = 1;
let selectedVersionNumber = null;

// Load versions when modal opens
$('#versionsModal').on('show.bs.modal', function() {
    loadVersions(1);
});

function loadVersions(page = 1) {
    currentVersionsPage = page;
    
    $('#versionsLoading').show();
    $('#versionsContent').hide();
    $('#versionsEmpty').hide();
    
    $.ajax({
        url: `/api/ioc/${iocId}/versions`,
        method: 'GET',
        data: { page: page, per_page: 10 },
        success: function(response) {
            $('#versionsLoading').hide();
            
            const versions = response.versions || [];
            const total = response.total || 0;
            const currentVersion = response.current_version || 1;
            
            $('#currentVersionNumber').text(currentVersion);
            
            if (versions.length === 0) {
                $('#versionsEmpty').show();
                return;
            }
            
            $('#versionsContent').show();
            
            const tbody = $('#versionsTableBody');
            tbody.empty();
            
            versions.forEach(version => {
                const modifiedDate = version.modified_at ? new Date(version.modified_at).toLocaleString() : '-';
                const modifiedBy = version.modified_by || 'System';
                const changesCount = version.changes ? Object.keys(version.changes).length : 0;
                const changesText = changesCount > 0 ? `${changesCount} field(s)` : '-';
                
                const isCurrent = version.version_number === currentVersion;
                
                tbody.append(`
                    <tr class="${isCurrent ? 'table-info' : ''}">
                        <td>
                            <strong>v${version.version_number}</strong>
                            ${isCurrent ? '<span class="badge bg-primary ms-2">Current</span>' : ''}
                        </td>
                        <td><small>${modifiedDate}</small></td>
                        <td><small>${escapeHtml(modifiedBy)}</small></td>
                        <td><small>${changesText}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewVersion(${version.version_number})">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${!isCurrent ? `
                            <button class="btn btn-sm btn-outline-warning" onclick="confirmRestoreVersion(${version.version_number})">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                `);
            });
            
            // Update pagination
            updateVersionsPagination(total, page, 10);
        },
        error: function(xhr) {
            $('#versionsLoading').hide();
            $('#versionsEmpty').show();
            console.error('Failed to load versions:', xhr.responseText);
        }
    });
}

function updateVersionsPagination(total, currentPage, perPage) {
    const totalPages = Math.ceil(total / perPage);
    const pagination = $('#versionsPagination');
    const ul = pagination.find('ul');
    ul.empty();
    
    if (totalPages <= 1) {
        pagination.hide();
        return;
    }
    
    pagination.show();
    
    // Previous button
    ul.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadVersions(${currentPage - 1}); return false;">Previous</a>
        </li>
    `);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            ul.append(`
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadVersions(${i}); return false;">${i}</a>
                </li>
            `);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            ul.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
        }
    }
    
    // Next button
    ul.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadVersions(${currentPage + 1}); return false;">Next</a>
        </li>
    `);
}

function viewVersion(versionNumber) {
    selectedVersionNumber = versionNumber;
    
    $.ajax({
        url: `/api/ioc/${iocId}/versions`,
        method: 'GET',
        data: { page: 1, per_page: 100 },
        success: function(response) {
            const versions = response.versions || [];
            const version = versions.find(v => v.version_number === versionNumber);
            
            if (version) {
                $('#versionJson').text(JSON.stringify(version.snapshot || version, null, 2));
                $('#versionDetailModalLabel').text(`Version ${versionNumber} Details`);
                
                // Show/hide restore button based on if it's current version
                const isCurrent = versionNumber === response.current_version;
                $('#restoreVersionBtn').toggle(!isCurrent);
                
                $('#versionDetailModal').modal('show');
            } else {
                showAlert('Version not found', 'warning');
            }
        },
        error: function() {
            showAlert('Failed to load version details', 'danger');
        }
    });
}

function confirmRestoreVersion(versionNumber) {
    if (confirm(`Are you sure you want to restore this IOC to version ${versionNumber}? This will create a new version with the restored data.`)) {
        restoreVersion(versionNumber);
    }
}

function restoreVersion(versionNumber) {
    $.ajax({
        url: `/api/ioc/${iocId}/versions/${versionNumber}/restore`,
        method: 'POST',
        success: function(response) {
            showAlert(`IOC restored to version ${versionNumber} successfully`, 'success');
            $('#versionsModal').modal('hide');
            $('#versionDetailModal').modal('hide');
            setTimeout(() => location.reload(), 1500);
        },
        error: function(xhr) {
            showAlert('Failed to restore version: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
        }
    });
}

$('#restoreVersionBtn').click(function() {
    if (selectedVersionNumber) {
        confirmRestoreVersion(selectedVersionNumber);
    }
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Report - {{ SITE_TITLE }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<div class="top-bar">
    <div>
        <h4 class="mb-0" id="reportTitle">Report</h4>
        <small class="text-muted" id="reportSubtitle">Generated on <span id="generatedAt"></span></small>
    </div>
    <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
            <i class="bi bi-printer me-2"></i> Print
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="downloadReport()">
            <i class="bi bi-download me-2"></i> Download
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body markdown-body" id="reportContent" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let reportData = null;
let reportType = null;
let reportId = null;

document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    reportType = urlParams.get('type');  // 'ioc', 'case', 'incident'
    reportId = urlParams.get('id');
    
    if (reportType && reportId) {
        generateReport();
    }
});

async function generateReport() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('task_id');
        
        // If task_id provided, fetch from view endpoint
        if (taskId) {
            const response = await fetch(`/api/reports/view/${taskId}`);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to generate report');
            }
            reportData = await response.json();
            displayReport();
            return;
        }
        
        // Otherwise, launch a new async generation
        let endpoint = '';
        switch(reportType) {
            case 'ioc':
                endpoint = `/api/reports/iocs/${reportId}`;
                break;
            case 'case':
                endpoint = `/api/reports/cases/${reportId}`;
                break;
            case 'incident':
                endpoint = `/api/reports/incidents/${reportId}`;
                break;
            default:
                showError('Invalid report type');
                return;
        }
        
        const response = await fetch(endpoint);
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate report');
        }
        
        const result = await response.json();
        if (result.task_id) {
            // Redirect to reports dashboard to track progress
            window.location.href = `/reports?task_id=${result.task_id}`;
            return;
        }
        
        // Legacy direct response (shouldn't happen with async)
        reportData = result;
        displayReport();
    } catch (error) {
        showError('Error generating report: ' + error.message);
    }
}

function displayReport() {
    const content = document.getElementById('reportContent');
    let markdown = '';
    
    switch(reportType) {
        case 'ioc':
            markdown = displayIOCReport();
            document.getElementById('reportTitle').textContent = `IOC Report: ${reportData.ioc_type.toUpperCase()}`;
            break;
        case 'case':
            markdown = displayCaseReport();
            document.getElementById('reportTitle').textContent = `Case Report: ${reportData.case_name}`;
            break;
        case 'incident':
            markdown = displayIncidentReport();
            document.getElementById('reportTitle').textContent = `Incident Report: ${reportData.incident_name}`;
            break;
    }
    
    document.getElementById('generatedAt').textContent = new Date(reportData.generated_at).toLocaleString();
    // Render markdown to HTML
    content.innerHTML = marked.parse(markdown);
}

function displayIOCReport() {
    return `## IOC Details

| Field | Value |
|-------|-------|
| **Type** | \`${reportData.ioc_type}\` |
| **Value** | \`${reportData.ioc_value}\` |
| **Related Indicators** | ${reportData.relations_count} |

## Analysis

${reportData.analysis}
`;
}

function displayCaseReport() {
    return `## Case Summary

| Field | Value |
|-------|-------|
| **Name** | ${reportData.case_name} |
| **Incidents** | ${reportData.incidents_count} |
| **IOCs** | ${reportData.iocs_count} |

## Investigation Report

${reportData.report}
`;
}

function displayIncidentReport() {
    return `## Incident Summary

| Field | Value |
|-------|-------|
| **Name** | ${reportData.incident_name} |
| **Associated IOCs** | ${reportData.iocs_count} |

## Threat Analysis

${reportData.analysis}
`;
}

function downloadReport() {
    if (!reportData) return;
    
    let markdown = '';
    switch(reportType) {
        case 'ioc':
            markdown = displayIOCReport();
            break;
        case 'case':
            markdown = displayCaseReport();
            break;
        case 'incident':
            markdown = displayIncidentReport();
            break;
    }
    
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(markdown));
    element.setAttribute('download', `report-${reportType}-${reportId}.md`);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

function showError(message) {
    document.getElementById('reportContent').innerHTML = 
        `<div class="alert alert-danger">${escapeHtml(message)}</div>`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<style>
@media print {
    .top-bar { display: none; }
    .btn { display: none; }
}

/* Markdown styling */
.markdown-body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: #24292e;
    word-wrap: break-word;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}

.markdown-body h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
.markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
.markdown-body h3 { font-size: 1.25em; }
.markdown-body h4 { font-size: 1em; }
.markdown-body h5 { font-size: 0.875em; }
.markdown-body h6 { font-size: 0.85em; color: #6a737d; }

.markdown-body p {
    margin-bottom: 16px;
}

.markdown-body ul,
.markdown-body ol {
    margin-bottom: 16px;
    padding-left: 2em;
}

.markdown-body li {
    margin-bottom: 8px;
}

.markdown-body code {
    background-color: #f6f8fa;
    border-radius: 3px;
    font-size: 85%;
    margin: 0;
    padding: 0.2em 0.4em;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    color: #24292e;
}

.markdown-body pre {
    background-color: #f6f8fa;
    border-radius: 6px;
    font-size: 85%;
    line-height: 1.45;
    overflow: auto;
    padding: 16px;
    margin-bottom: 16px;
}

.markdown-body pre code {
    background-color: transparent;
    border: 0;
    display: inline;
    line-height: inherit;
    margin: 0;
    overflow: visible;
    padding: 0;
    word-wrap: normal;
    color: inherit;
}

.markdown-body table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 16px;
}

.markdown-body table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}

.markdown-body table tr:nth-child(2n) {
    background-color: #f6f8fa;
}

.markdown-body table td,
.markdown-body table th {
    border: 1px solid #dfe2e5;
    padding: 6px 13px;
}

.markdown-body table th {
    background-color: #f6f8fa;
    font-weight: 600;
}

.markdown-body blockquote {
    border-left: 0.25em solid #dfe2e5;
    color: #6a737d;
    margin-bottom: 16px;
    margin-left: 0;
    margin-right: 0;
    margin-top: 0;
    padding: 0 1em;
}

.markdown-body strong {
    font-weight: 600;
}

.markdown-body em {
    font-style: italic;
}

.markdown-body a {
    background-color: transparent;
    color: #0366d6;
    text-decoration: none;
}

.markdown-body a:hover {
    text-decoration: underline;
}

.markdown-body hr {
    background-color: #e1e4e8;
    border: 0;
    height: 0.25em;
    margin: 24px 0;
    padding: 0;
}
</style>
{% endblock %}

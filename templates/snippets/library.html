{% extends "base.html" %}

{% block title %}Snippets Library - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0"><i class="bi bi-file-earmark-text me-2"></i>Snippets Library</h1>
            <p class="text-muted mb-0">Reusable markdown templates for incident reports</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSnippetModal">
            <i class="bi bi-plus-lg me-1"></i> New Snippet
        </button>
    </div>

    <div class="row">
        <!-- Categories Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-folder me-2"></i>Categories</h6>
                </div>
                <div class="list-group list-group-flush" id="categoriesList">
                    <a href="#" class="list-group-item list-group-item-action active" data-category="" onclick="filterByCategory('', this)">
                        All Snippets <span class="badge bg-secondary float-end" id="countAll">0</span>
                    </a>
                </div>
                <div class="card-body" style="border-top: 1px solid var(--border-color);">
                    <p class="text-muted small mb-2">Categories will appear here as you create snippets.</p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label small">Show</label>
                        <select class="form-select form-select-sm" id="ownerFilter" onchange="loadSnippets()">
                            <option value="all">All Snippets</option>
                            <option value="mine">My Snippets</option>
                            <option value="global">Global Only</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeGlobal" checked onchange="loadSnippets()">
                        <label class="form-check-label small" for="includeGlobal">Include Global</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Snippets List -->
        <div class="col-md-9">
            <!-- Search -->
            <div class="input-group mb-4">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search snippets...">
            </div>

            <!-- Snippets Grid -->
            <div id="snippetsContainer" class="row">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>

            <!-- Pagination -->
            <nav class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted" id="paginationInfo">-</div>
                <ul class="pagination mb-0" id="paginationList"></ul>
            </nav>
        </div>
    </div>
</div>

<!-- Create/Edit Snippet Modal -->
<div class="modal fade" id="createSnippetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="snippetModalTitle">Create New Snippet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="snippetForm">
                    <input type="hidden" id="snippetId">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="snippetTitle" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" id="snippetCategory" placeholder="e.g., Executive Summary, Technical Analysis...">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="snippetDescription" placeholder="Brief description of this snippet">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Content (Markdown) <span class="text-danger">*</span></label>
                        <textarea class="form-control font-monospace" id="snippetContent" rows="12" required placeholder="## Section Title&#10;&#10;Your markdown content here..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" class="form-control" id="snippetTags" placeholder="Comma-separated tags">
                    </div>

                    {% if current_user.is_admin %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="snippetGlobal">
                        <label class="form-check-label" for="snippetGlobal">
                            <i class="bi bi-globe me-1"></i> Make this a global snippet (visible to all users)
                        </label>
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSnippet()">
                    <i class="bi bi-check-lg me-1"></i> Save Snippet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewTitle">Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent" class="p-3 bg-light rounded"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" id="copySnippetBtn">
                    <i class="bi bi-clipboard me-1"></i> Copy Content
                </button>
                <button type="button" class="btn btn-outline-success" id="exportSnippetBtn">
                    <i class="bi bi-download me-1"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let currentPage = 1;
const perPage = 12;
let currentCategory = '';
let currentPreviewId = null;

function loadSnippets() {
    const params = new URLSearchParams({
        page: currentPage,
        per_page: perPage,
        search: document.getElementById('searchInput').value,
        include_global: document.getElementById('includeGlobal').checked
    });

    if (currentCategory) {
        params.append('category', currentCategory);
    }

    fetch(`/api/snippets?${params}`)
        .then(r => r.json())
        .then(data => {
            renderSnippets(data.items || []);
            renderPagination(data.total || 0, currentPage, perPage);
        });

    // Update category counts
    loadCategoryCounts();
}

function loadCategoryCounts() {
    fetch('/api/snippets/categories')
        .then(r => r.json())
        .then(data => {
            const categoriesList = document.getElementById('categoriesList');
            const categories = data.categories || [];
            let total = 0;
            
            // Clear existing categories (keep "All Snippets")
            const allElement = categoriesList.querySelector('[data-category=""]');
            categoriesList.innerHTML = '';
            if (allElement) {
                categoriesList.appendChild(allElement);
            }
            
            // Add each category dynamically
            categories.forEach(cat => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'list-group-item list-group-item-action';
                link.textContent = cat.name;
                link.innerHTML = `${escapeHtml(cat.name)} <span class="badge bg-secondary float-end">${cat.count}</span>`;
                link.onclick = (e) => {
                    e.preventDefault();
                    filterByCategory(cat.name, link);
                };
                categoriesList.appendChild(link);
                total += cat.count;
            });
            
            // Update total count
            document.getElementById('countAll').textContent = total;
        })
        .catch(e => console.error('Error loading categories:', e));
}

function renderSnippets(snippets) {
    const container = document.getElementById('snippetsContainer');

    if (snippets.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5 text-muted">
                <i class="bi bi-file-earmark-x display-1"></i>
                <p class="mt-3">No snippets found</p>
                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#createSnippetModal">
                    Create your first snippet
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = snippets.map(s => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <span class="badge bg-secondary">${s.category}</span>
                    <div>
                        ${s.is_global ? '<i class="bi bi-globe text-primary" title="Global"></i>' : ''}
                        <span class="badge bg-light text-dark" title="Usage count"><i class="bi bi-graph-up"></i> ${s.usage_count || 0}</span>
                    </div>
                </div>
                <div class="card-body">
                    <h6 class="card-title">${escapeHtml(s.title)}</h6>
                    <p class="card-text small text-muted">${escapeHtml(s.description || 'No description')}</p>
                    <div class="d-flex flex-wrap gap-1">
                        ${(s.tags || []).slice(0, 3).map(t => `<span class="badge bg-light text-dark">${t}</span>`).join('')}
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="btn-group btn-group-sm w-100">
                        <button class="btn btn-outline-primary" onclick="previewSnippet('${s.id}')" title="Preview">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editSnippet('${s.id}')" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="copySnippet('${s.id}')" title="Copy">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteSnippet('${s.id}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function filterByCategory(category, elem) {
    currentCategory = category;
    currentPage = 1;

    document.querySelectorAll('#categoriesList a').forEach(a => a.classList.remove('active'));
    elem.classList.add('active');

    loadSnippets();
}

function previewSnippet(id) {
    currentPreviewId = id;
    fetch(`/api/snippets/${id}`)
        .then(r => r.json())
        .then(s => {
            document.getElementById('previewTitle').textContent = s.title;
            document.getElementById('previewContent').innerHTML = marked.parse(s.content);
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        });
}

function editSnippet(id) {
    fetch(`/api/snippets/${id}`)
        .then(r => r.json())
        .then(s => {
            document.getElementById('snippetModalTitle').textContent = 'Edit Snippet';
            document.getElementById('snippetId').value = s.id;
            document.getElementById('snippetTitle').value = s.title;
            document.getElementById('snippetCategory').value = s.category;
            document.getElementById('snippetDescription').value = s.description || '';
            document.getElementById('snippetContent').value = s.content;
            document.getElementById('snippetTags').value = (s.tags || []).join(', ');
            
            const globalCb = document.getElementById('snippetGlobal');
            if (globalCb) globalCb.checked = s.is_global;
            
            new bootstrap.Modal(document.getElementById('createSnippetModal')).show();
        });
}

function saveSnippet() {
    const id = document.getElementById('snippetId').value;
    const data = {
        title: document.getElementById('snippetTitle').value.trim(),
        category: document.getElementById('snippetCategory').value,
        description: document.getElementById('snippetDescription').value,
        content: document.getElementById('snippetContent').value,
        tags: document.getElementById('snippetTags').value.split(',').map(t => t.trim()).filter(t => t)
    };

    const globalCb = document.getElementById('snippetGlobal');
    if (globalCb) data.is_global = globalCb.checked;

    const url = id ? `/api/snippets/${id}` : '/api/snippets';
    const method = id ? 'PUT' : 'POST';

    fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => {
        if (r.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createSnippetModal')).hide();
            resetForm();
            loadSnippets();
        } else {
            alert('Error saving snippet');
        }
    });
}

function copySnippet(id) {
    fetch(`/api/snippets/${id}/use`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            navigator.clipboard.writeText(data.content)
                .then(() => alert('Snippet copied to clipboard!'));
        });
}

function deleteSnippet(id) {
    if (!confirm('Delete this snippet?')) return;

    fetch(`/api/snippets/${id}`, { method: 'DELETE' })
        .then(r => {
            if (r.ok) loadSnippets();
        });
}

function resetForm() {
    document.getElementById('snippetId').value = '';
    document.getElementById('snippetTitle').value = '';
    document.getElementById('snippetCategory').value = 'other';
    document.getElementById('snippetDescription').value = '';
    document.getElementById('snippetContent').value = '';
    document.getElementById('snippetTags').value = '';
    document.getElementById('snippetModalTitle').textContent = 'Create New Snippet';
    
    const globalCb = document.getElementById('snippetGlobal');
    if (globalCb) globalCb.checked = false;
}

function renderPagination(total, page, perPage) {
    const totalPages = Math.ceil(total / perPage);
    const start = (page - 1) * perPage + 1;
    const end = Math.min(page * perPage, total);

    document.getElementById('paginationInfo').textContent = 
        total > 0 ? `Showing ${start}-${end} of ${total}` : 'No results';

    const list = document.getElementById('paginationList');
    if (totalPages <= 1) {
        list.innerHTML = '';
        return;
    }

    let html = `<li class="page-item ${page === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${page - 1}); return false;">&laquo;</a>
    </li>`;

    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `<li class="page-item ${page === i ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
        </li>`;
    }

    html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${page + 1}); return false;">&raquo;</a>
    </li>`;

    list.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    loadSnippets();
}


function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Copy from preview modal
document.getElementById('copySnippetBtn').addEventListener('click', function() {
    if (currentPreviewId) copySnippet(currentPreviewId);
});

// Export from preview modal
document.getElementById('exportSnippetBtn').addEventListener('click', function() {
    if (!currentPreviewId) return;
    
    fetch(`/api/snippets/${currentPreviewId}/export`)
        .then(r => r.text())
        .then(content => {
            const blob = new Blob([content], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `snippet-${currentPreviewId}.md`;
            a.click();
        });
});

// Reset form when modal opens for new snippet
document.getElementById('createSnippetModal').addEventListener('show.bs.modal', function(e) {
    if (!e.relatedTarget || e.relatedTarget.textContent.includes('New')) {
        resetForm();
    }
});

// Search
document.getElementById('searchInput').addEventListener('input', debounce(loadSnippets, 300));

// Initial load
loadSnippets();
</script>
{% endblock %}

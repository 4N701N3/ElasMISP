{% extends "base.html" %}

{% block title %}Incidents - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Incidents</h1>
            <p class="text-muted mb-0">Security incidents with IOCs and report generation</p>
        </div>
        <a href="{{ url_for('main.incidents_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> New Incident
        </a>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search incidents...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="new">New</option>
                        <option value="investigating">Investigating</option>
                        <option value="containment">Containment</option>
                        <option value="eradication">Eradication</option>
                        <option value="recovery">Recovery</option>
                        <option value="post-incident">Post-Incident</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="severityFilter">
                        <option value="">All Severity</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="malware">Malware</option>
                        <option value="ransomware">Ransomware</option>
                        <option value="phishing">Phishing</option>
                        <option value="data-breach">Data Breach</option>
                        <option value="ddos">DDoS</option>
                        <option value="intrusion">Intrusion</option>
                        <option value="insider-threat">Insider Threat</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sortBy">
                        <option value="created_desc">Latest First</option>
                        <option value="created_asc">Oldest First</option>
                        <option value="title_asc">Title A-Z</option>
                        <option value="title_desc">Title Z-A</option>
                        <option value="severity_desc">Highest Severity</option>
                        <option value="severity_asc">Lowest Severity</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Incidents Grid -->
    <div class="row" id="incidentsGrid">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav class="d-flex justify-content-between align-items-center mt-4">
        <div class="text-muted" id="paginationInfo">Showing 0 of 0</div>
        <ul class="pagination mb-0" id="paginationList"></ul>
    </nav>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
const perPage = 12;

function loadIncidents() {
    const params = new URLSearchParams({
        page: currentPage,
        per_page: perPage,
        status: document.getElementById('statusFilter').value,
        severity: document.getElementById('severityFilter').value,
        search: document.getElementById('searchInput').value,
        sort: document.getElementById('sortBy').value
    });

    for (const [key, value] of [...params.entries()]) {
        if (!value) params.delete(key);
    }

    fetch(`/api/incidents?${params}`)
        .then(r => r.json())
        .then(data => {
            renderIncidents(data.items || []);
            renderPagination(data.total || 0, currentPage, perPage);
        })
        .catch(error => {
            document.getElementById('incidentsGrid').innerHTML = `
                <div class="col-12 text-center text-danger py-5">Error loading incidents</div>
            `;
        });
}

function renderIncidents(incidents) {
    const grid = document.getElementById('incidentsGrid');
    
    if (incidents.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center py-5 text-muted">
                <i class="bi bi-inbox display-1"></i>
                <p class="mt-3">No incidents found</p>
            </div>
        `;
        return;
    }

    grid.innerHTML = incidents.map(inc => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="badge bg-${getSeverityColor(inc.severity)}">${inc.severity}</span>
                    <span class="badge bg-${getStatusColor(inc.status)}">${inc.status}</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="/incidents/${inc.id}" class="text-decoration-none">${escapeHtml(inc.title)}</a>
                    </h5>
                    <p class="card-text text-muted small">
                        ${escapeHtml((inc.description || '').substring(0, 150))}${(inc.description || '').length > 150 ? '...' : ''}
                    </p>
                    <div class="d-flex flex-wrap gap-1 mb-2">
                        <span class="badge bg-secondary">${inc.category || 'uncategorized'}</span>
                        ${(inc.mitre_tactics || []).slice(0, 2).map(t => `<span class="badge bg-dark">${t}</span>`).join('')}
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-shield-exclamation me-1"></i>${(inc.ioc_ids || []).length} IOCs
                        </small>
                        <small class="text-muted">${formatDate(inc.created_at)}</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function getSeverityColor(severity) {
    const colors = { critical: 'danger', high: 'warning', medium: 'info', low: 'secondary' };
    return colors[severity] || 'secondary';
}

function getStatusColor(status) {
    const colors = {
        new: 'primary',
        investigating: 'info',
        containment: 'warning',
        eradication: 'warning',
        recovery: 'success',
        'post-incident': 'secondary',
        closed: 'dark'
    };
    return colors[status] || 'secondary';
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}


function renderPagination(total, page, perPage) {
    const totalPages = Math.ceil(total / perPage);
    const start = (page - 1) * perPage + 1;
    const end = Math.min(page * perPage, total);

    document.getElementById('paginationInfo').textContent = 
        total > 0 ? `Showing ${start}-${end} of ${total}` : 'No results';

    const list = document.getElementById('paginationList');
    if (totalPages <= 1) {
        list.innerHTML = '';
        return;
    }

    let html = `<li class="page-item ${page === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${page - 1}); return false;">&laquo;</a>
    </li>`;

    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `<li class="page-item ${page === i ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
        </li>`;
    }

    html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${page + 1}); return false;">&raquo;</a>
    </li>`;

    list.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    loadIncidents();
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('severityFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    currentPage = 1;
    loadIncidents();
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

document.getElementById('searchInput').addEventListener('input', debounce(loadIncidents, 300));
document.getElementById('statusFilter').addEventListener('change', loadIncidents);
document.getElementById('severityFilter').addEventListener('change', loadIncidents);
document.getElementById('categoryFilter').addEventListener('change', loadIncidents);
document.getElementById('sortBy').addEventListener('change', loadIncidents);

loadIncidents();
</script>
{% endblock %}
